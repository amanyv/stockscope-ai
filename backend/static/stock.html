<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Stock Analysis · StockScope AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
        :root {
            --bg: #f8f9fa;
            --surface: #ffffff;
            --primary: #4f46e5;
            --secondary: #38bdf8;
            --accent: #10b981;
            --text: #2d3436;
            --text-light: #636e72;
            --text-ultralight: #95a5a6;
            --border: #dfe6e9;
            --border-light: #ecf0f1;
            --success: #00b894;
            --danger: #ff7675;
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
        }

        .header {
            background: #fff;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-inner {
            max-width: 1400px;
            margin: auto;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: url("/static/favicon.svg") center/contain no-repeat;
        }

        .brand {
            font-size: 20px;
            font-weight: 700;
        }

        .back-btn {
            padding: 8px 18px;
            background: #fff;
            color: var(--text-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 32px 24px;
        }

        .section {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 32px;
        }

        .company-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 8px 0;
        }

        .company-subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        .price-info {
            text-align: right;
        }

        .price-large {
            font-size: 36px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .price-change {
            font-size: 14px;
            font-weight: 500;
            margin-top: 4px;
        }

        .price-change.positive {
            color: var(--success);
        }

        .price-change.negative {
            color: var(--danger);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 20px 0;
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--text-light);
            margin: -16px 0 20px 0;
        }

        .metrics-table {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            border-top: 1px solid var(--border-light);
        }

        .metric-cell {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-cell:nth-child(3n+1) {
            border-right: 1px solid var(--border-light);
        }

        .metric-cell:nth-child(3n+2) {
            border-right: 1px solid var(--border-light);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 400;
        }

        .metric-value {
            font-size: 15px;
            color: var(--text);
            font-weight: 600;
            text-align: right;
        }

        .chart-wrapper {
            margin-top: 20px;
            padding: 20px;
            background: #fafbfc;
            border-radius: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 16px;
        }

        .quarterly-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: auto;
        }

        .quarterly-table thead {
            background: #fafbfc;
        }

        .quarterly-table th {
            padding: 14px 10px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
            width: auto;
        }

        .quarterly-table th:first-child {
            text-align: left;
            width: 140px;
            min-width: 140px;
        }

        .quarterly-table td {
            padding: 14px 10px;
            text-align: right;
            color: var(--text);
            border-bottom: 1px solid var(--border-light);
            font-weight: 500;
            white-space: nowrap;
        }

        .quarterly-table td:first-child {
            text-align: left;
            font-weight: 600;
            position: sticky;
            left: 0;
            background: #fff;
            z-index: 2;
        }

        .quarterly-table thead th:first-child {
            position: sticky;
            left: 0;
            background: #fafbfc;
            z-index: 3;
        }

        .quarterly-table tbody tr:hover {
            background: #fafbfc;
        }

        .quarterly-table tbody tr:hover td:first-child {
            background: #fafbfc;
        }

        .data-table {
            width: 100%;
            min-width: 1400px;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table thead {
            background: #fafbfc;
        }

        .data-table th {
            padding: 14px 12px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 2px solid var(--border);
        }

        .data-table th:first-child,
        .data-table th:nth-child(2) {
            text-align: left;
        }

        .data-table td {
            padding: 14px 12px;
            text-align: right;
            color: var(--text);
            border-bottom: 1px solid var(--border-light);
            font-weight: 500;
        }

        .data-table td:first-child,
        .data-table td:nth-child(2) {
            text-align: left;
        }

        .data-table th:first-child,
        .data-table td:first-child {
            position: sticky;
            left: 0;
            background: #fff;
            font-weight: 600;
            z-index: 2;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            position: sticky;
            left: 60px;
            background: #fff;
            z-index: 2;
            min-width: 220px;
        }

        .data-table thead th:first-child,
        .data-table thead th:nth-child(2) {
            background: #fafbfc;
        }

        .data-table tbody tr:hover {
            background: #fafbfc;
        }

        .current-stock-row {
            background: #f0f7ff !important;
            font-weight: 600;
        }

        .current-stock-row td:first-child,
        .current-stock-row td:nth-child(2) {
            background: #f0f7ff !important;
        }

        .positive-value {
            color: var(--success);
            font-weight: 600;
        }

        .negative-value {
            color: var(--danger);
            font-weight: 600;
        }

        .insight-list {
            list-style: none;
            padding: 0;
            margin: 16px 0 0 0;
        }

        .insight-item {
            padding: 14px 0;
            border-bottom: 1px solid var(--border-light);
            line-height: 1.6;
            color: var(--text);
            font-size: 14px;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-item::before {
            content: '•';
            color: var(--primary);
            font-weight: bold;
            display: inline-block;
            width: 20px;
        }

        .about-content {
            line-height: 1.7;
            color: var(--text);
            font-size: 14px;
        }

        .no-data {
            padding: 40px;
            text-align: center;
            color: var(--text-light);
            font-size: 14px;
            background: #fafbfc;
            border-radius: 8px;
            margin-top: 16px;
        }

        @media (max-width: 900px) {
            .company-header {
                flex-direction: column;
                gap: 16px;
            }

            .price-info {
                text-align: left;
            }

            .metrics-table {
                grid-template-columns: 1fr;
            }

            .metric-cell {
                border-right: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-inner">
            <div class="brand-wrap">
                <div class="logo"></div>
                <div class="brand">StockScope AI</div>
            </div>
            <button class="back-btn" onclick="location.href='/'">← Back</button>
        </div>
    </div>

    <div class="container" id="content"></div>

    <script>
        function formatNumber(num) {
            if (num === null || num === undefined || num === "—" || num === "") return "—";
            if (typeof num === 'string' && /[^0-9.\-,]/.test(num.replace(/,/g, ''))) return num;
            const value = typeof num === 'string' ? parseFloat(num.replace(/,/g, '')) : num;
            if (isNaN(value)) return "—";
            return value.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 0 });
        }

        function formatCrores(num) {
            if (num === null || num === undefined || num === "—" || num === "") return "—";
            const value = typeof num === 'string' ? parseFloat(num.replace(/,/g, '')) : num;
            if (isNaN(value)) return "—";
            let croreValue = value;
            if (value > 100000) {
                croreValue = value / 10000000;
            }
            return croreValue.toLocaleString('en-IN', { maximumFractionDigits: 0, minimumFractionDigits: 0 });
        }

        function formatPercentage(num) {
            if (num === null || num === undefined || num === "—" || num === "") return "—";
            const value = typeof num === 'string' ? parseFloat(num.replace(/,/g, '').replace('%', '')) : num;
            if (isNaN(value)) return "—";
            return formatNumber(value) + "%";
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const content = document.getElementById("content");
            const params = new URLSearchParams(window.location.search);
            const symbol = params.get("symbol");

            if (!symbol) {
                content.innerHTML = "<div class='no-data'>No stock selected.</div>";
                return;
            }

            try {
                // FETCH ALL DATA IN PARALLEL
                const [stock, aiResult, chartResult] = await Promise.all([
                    fetch(`/api/stock/${symbol}`).then(r => r.json()),
                    fetch(`/api/ai/insights/${symbol}`).then(r => r.json()).catch(() => ({ analysis: { ai_observations: [] } })),
                    fetch(`/api/chart/${symbol}?period=1y`).then(r => r.json())
                ]);

                const chartData = chartResult;
                const ai = aiResult;
                const changeClass = stock.company.change_pct >= 0 ? 'positive' : 'negative';
                const changeSymbol = stock.company.change_pct >= 0 ? '▲' : '▼';

                // RENDER ALL CONTENT AT ONCE - ORIGINAL ORDER
                content.innerHTML = `
    <div class="section">
        <div class="company-header">
            <div>
                <h1 class="company-title">${stock.company.name}</h1>
                <p class="company-subtitle">${stock.company.sector} / ${stock.company.industry}</p>
            </div>
            <div class="price-info">
                <div class="price-large">₹${formatNumber(stock.company.price)}</div>
                <div class="price-change ${changeClass}">${changeSymbol} ${formatNumber(Math.abs(stock.company.change_pct))}%</div>
            </div>
        </div>

        <h3 class="section-title">Key Metrics</h3>
        <div class="metrics-table">
            ${Object.entries(stock.metrics)
                .map(([k, v]) => {
                    let displayValue = "—";
                    if (v !== null && v !== undefined) {
                        if (k === "roe" || k === "roce" || k === "dividend_yield") {
                            displayValue = formatPercentage(v);
                        } else {
                            displayValue = formatNumber(v);
                        }
                    }
                    return `
            <div class="metric-cell">
                <span class="metric-label">${k.replace(/_/g, " ").toUpperCase()}</span>
                <span class="metric-value">${displayValue}</span>
            </div>`;
                }).join("")}
        </div>
    </div>

    <div class="section">
        <h3 class="section-title">Price Chart</h3>
        <p class="section-subtitle">1-year price movement with 50 & 200 DMA</p>
        <div class="chart-wrapper">
            <canvas id="priceChart" height="90"></canvas>
        </div>
    </div>

    ${stock.quarterly_results ? `
    <div class="section">
        <h3 class="section-title">Quarterly Results</h3>
        <p class="section-subtitle">Consolidated figures (₹ Crores)</p>
        <div class="table-wrapper">
            <table class="quarterly-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        ${stock.quarterly_results.quarters.map((q) => `<th>${q}</th>`).join("")}
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(stock.quarterly_results.rows)
                        .map(([k, vals]) => `
                    <tr>
                        <td>${k}</td>
                        ${vals.map((v) => `<td>${formatCrores(v)}</td>`).join("")}
                    </tr>
                    `).join("")}
                </tbody>
            </table>
        </div>
    </div>` : ""}

    <div class="section">
        <h3 class="section-title">Peer Comparison</h3>
        <p class="section-subtitle">Comprehensive financial comparison with quarterly metrics</p>
        ${!stock.company.is_listed
            ? `<div class="no-data">Peer comparison is available only for listed companies.</div>`
            : stock.sector_overview.peers.length === 0
                ? `<div class="no-data">No comparable peer companies found.</div>`
                : `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Company Name</th>
                        <th>CMP</th>
                        <th>P/E</th>
                        <th>Mkt Cap (Cr)</th>
                        <th>Div Yld %</th>
                        <th>ROE %</th>
                        <th>ROCE %</th>
                        <th>NP Qtr (Cr)</th>
                        <th>Profit Var %</th>
                        <th>Sales Qtr (Cr)</th>
                        <th>Sales Var %</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="current-stock-row">
                        <td>1</td>
                        <td>${stock.company.name}</td>
                        <td>${formatNumber(stock.company.price)}</td>
                        <td>${formatNumber(stock.metrics.pe)}</td>
                        <td>${formatNumber(stock.metrics.market_cap_cr)}</td>
                        <td>${formatNumber(stock.metrics.dividend_yield)}</td>
                        <td>${formatNumber(stock.metrics.roe)}</td>
                        <td>${formatNumber(stock.metrics.roce)}</td>
                        <td>${formatNumber(stock.quarterly_metrics?.quarterly_profit)}</td>
                        <td class="${(stock.quarterly_metrics?.quarterly_profit_growth ?? 0) >= 0 ? 'positive-value' : 'negative-value'}">
                            ${formatNumber(stock.quarterly_metrics?.quarterly_profit_growth)}
                        </td>
                        <td>${formatNumber(stock.quarterly_metrics?.quarterly_revenue)}</td>
                        <td class="${(stock.quarterly_metrics?.quarterly_revenue_growth ?? 0) >= 0 ? 'positive-value' : 'negative-value'}">
                            ${formatNumber(stock.quarterly_metrics?.quarterly_revenue_growth)}
                        </td>
                    </tr>
                    ${stock.sector_overview.peers
                        .map((p, index) => {
                            const profitClass = (p.quarterly_profit_growth ?? 0) >= 0 ? 'positive-value' : 'negative-value';
                            const salesClass = (p.quarterly_revenue_growth ?? 0) >= 0 ? 'positive-value' : 'negative-value';
                            return `
                    <tr>
                        <td>${index + 2}</td>
                        <td>${p.name || p.symbol}</td>
                        <td>${formatNumber(p.current_price)}</td>
                        <td>${formatNumber(p.pe)}</td>
                        <td>${formatNumber(p.market_cap_cr)}</td>
                        <td>${formatNumber(p.dividend_yield)}</td>
                        <td>${formatNumber(p.roe)}</td>
                        <td>${formatNumber(p.roce)}</td>
                        <td>${formatNumber(p.quarterly_profit)}</td>
                        <td class="${profitClass}">${formatNumber(p.quarterly_profit_growth)}</td>
                        <td>${formatNumber(p.quarterly_revenue)}</td>
                        <td class="${salesClass}">${formatNumber(p.quarterly_revenue_growth)}</td>
                    </tr>
                    `;
                        }).join("")}
                </tbody>
            </table>
        </div>
        `}
    </div>

    <div class="section">
        <h3 class="section-title">AI Observations</h3>
        <p class="section-subtitle">Automated insights and analysis</p>
        ${(ai.analysis?.ai_observations?.length > 0)
            ? `<ul class="insight-list">${ai.analysis.ai_observations.map((i) => `<li class="insight-item">${i}</li>`).join("")}</ul>`
            : `<div class="no-data">AI analysis in progress...</div>`}
    </div>

    ${stock.about ? `
    <div class="section">
        <h3 class="section-title">About ${stock.company.name}</h3>
        <div class="about-content">${stock.about}</div>
    </div>
    ` : ""}
  `;

                // RENDER CHART
                setTimeout(() => {
                    const ctx = document.getElementById("priceChart")?.getContext("2d");
                    if (!ctx) return;

                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, "rgba(79,70,229,0.15)");
                    gradient.addColorStop(1, "rgba(79,70,229,0.01)");

                    new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: chartData.dates,
                            datasets: [
                                {
                                    label: "Price",
                                    data: chartData.price,
                                    borderColor: "#4f46e5",
                                    backgroundColor: gradient,
                                    fill: true,
                                    tension: 0.3,
                                    pointRadius: 0,
                                    borderWidth: 2,
                                },
                                {
                                    label: "50 DMA",
                                    data: chartData.dma50,
                                    borderColor: "#00b894",
                                    borderDash: [5, 3],
                                    pointRadius: 0,
                                    borderWidth: 1.5,
                                    fill: false,
                                },
                                {
                                    label: "200 DMA",
                                    data: chartData.dma200,
                                    borderColor: "#ff7675",
                                    borderDash: [5, 3],
                                    pointRadius: 0,
                                    borderWidth: 1.5,
                                    fill: false,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15,
                                        font: { size: 12, weight: '500' },
                                        color: '#636e72'
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                    titleColor: '#2d3436',
                                    bodyColor: '#636e72',
                                    borderColor: '#dfe6e9',
                                    borderWidth: 1,
                                    padding: 10,
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed.y !== null) {
                                                label += '₹' + context.parsed.y.toLocaleString('en-IN', {maximumFractionDigits: 2});
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: { unit: 'month', displayFormats: { month: 'MMM yyyy' } },
                                    grid: { display: false },
                                    ticks: { font: { size: 11 }, color: '#95a5a6' }
                                },
                                y: {
                                    grid: { color: '#ecf0f1' },
                                    ticks: {
                                        font: { size: 11 },
                                        color: '#95a5a6',
                                        callback: function (value) { 
                                            return '₹' + value.toLocaleString('en-IN'); 
                                        }
                                    }
                                }
                            }
                        }
                    });
                }, 50);

            } catch (error) {
                content.innerHTML = `<div class="no-data" style="color:var(--danger)">
                    <strong>Error Loading Stock Data</strong><br>
                    ${error.message}
                </div>`;
                console.error(error);
            }
        });
    </script>
</body>

</html>